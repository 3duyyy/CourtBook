table users {
  id int [pk, increment]
  role_id int [not null]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  full_name varchar(100) [not null]
  phone varchar(20)
  avatar_url varchar(500)
  status enum('active', 'banned', 'pending_approve') // default: active
  is_verified boolean // default: false
  created_at datetime
  updated_at datetime
}

table roles {
  id int [pk, increment]
  name varchar(50) [unique, not null] // 'admin', 'owner', 'customer'
  description varchar(255)
  created_at datetime
  updated_at datetime
}

table permissions {
  id int [pk, increment]
  slug varchar(100) [unique, not null] // 'field.create', 'user.ban'
  name varchar(100)
  created_at datetime
  updated_at datetime
}

table role_permissions {
  role_id int [not null]
  permission_id int [not null]

  indexes {
    (role_id, permission_id) [pk]
  }
}

table sports {
  id int [pk, increment]
  name varchar(50) [not null]
  icon_url varchar(500)
  created_at datetime
  updated_at datetime
}

table utilities {
  id int [pk, increment]
  name varchar(100) [not null]
  icon_class varchar(50)
  created_at datetime
  updated_at datetime
}

// Cụm sân (Sân Mỹ Đình, Sân Thống Nhất,...)
table facilities {
  id int [pk, increment]
  owner_id int [not null]
  sport_id int [not null]
  name varchar(100) [not null]
  description text
  address varchar(255) [not null]
  district varchar(100)
  city varchar(100)
  latitude decimal(10, 8)
  longitude decimal(11, 8)
  status enum('pending_approve', 'active', 'inactive') // default: pending_approve
  open_time varchar(5) // "06:00"
  close_time varchar(5) // "22:00"
  created_at datetime
  updated_at datetime
}

table facility_images {
  id int [pk, increment]
  facility_id int [not null]
  image_url varchar(500) [not null]
  is_thumbnail boolean // default: false
  created_at datetime
  updated_at datetime
}

table facility_utilities {
  facility_id int [not null]
  utility_id int [not null]

  indexes {
    (facility_id, utility_id) [pk]
  }
}

// Sân con (Sân số 1, Sân số 2,...)
table fields {
  id int [pk, increment]
  facility_id int [not null]
  name varchar(100) [not null] // "Sân số 1", "Sân 5 người A"
  description text
  status enum('active', 'maintenance', 'inactive') // default: active
  created_at datetime
  updated_at datetime
}

table field_pricing {
  id int [pk, increment]
  field_id int [not null]
  start_time varchar(5) [not null] // "06:00"
  end_time varchar(5) [not null]   // "17:00"
  price_per_hour decimal(15, 2) [not null]
  is_weekend boolean // default: false
  created_at datetime
  updated_at datetime
}

table bookings {
  id int [pk, increment]
  user_id int [not null]
  field_id int [not null]
  start_time datetime [not null]
  end_time datetime [not null]
  total_price decimal(15, 2) [not null]
  deposit_amount decimal(15, 2) // null = full payment
  status enum('pending', 'confirmed', 'completed', 'cancelled', 'rejected') // default: pending
  payment_status enum('unpaid', 'paid', 'refunded') // default: unpaid
  check_in_code varchar(100) [unique]
  note text
  rejection_reason varchar(255)
  created_at datetime
  updated_at datetime
}

table transactions {
  id int [pk, increment]
  booking_id int [not null]
  amount decimal(15, 2) [not null]
  type enum('payment', 'refund') [not null]
  method enum('qr_transfer', 'cash') // default: qr_transfer
  status enum('pending', 'success', 'failed') // default: success
  description varchar(255)
  created_at datetime
  updated_at datetime
}

table refund_requests {
  id int [pk, increment]
  user_id int [not null]
  booking_id int [not null, unique]
  amount decimal(15, 2) [not null]
  bank_name varchar(100) [not null]     // 'BIDV'
  bank_account varchar(50) [not null]   // '0999999999'
  account_holder varchar(100) [not null] // 'NGUYEN VAN A'
  reason text
  status enum('pending', 'approved', 'rejected') // default: pending
  admin_note text
  proof_image_url varchar(500) // Admin upload ảnh bằng chứng chuyển khoản
  created_at datetime
  updated_at datetime
}

table reviews {
  id int [pk, increment]
  booking_id int [not null, unique]
  user_id int [not null]
  facility_id int [not null] // Review cho cụm sân, không phải sân con
  rating int [not null, note: '1-5']
  comment text
  owner_reply text
  owner_reply_at datetime
  created_at datetime
  updated_at datetime
}

table notifications {
  id int [pk, increment]
  user_id int [not null]
  title varchar(255)
  message text
  type enum('system', 'booking', 'promotion') // default: system
  is_read boolean // default: false
  created_at datetime
  updated_at datetime
}

table chat_logs {
  id int [pk, increment]
  user_id int
  session_id varchar(100)
  message_content text
  sender enum('user', 'bot') [not null]
  created_at datetime
  updated_at datetime
}

// ==================== RELATIONS ====================

// Users
ref: roles.id < users.role_id
ref: roles.id < role_permissions.role_id
ref: permissions.id < role_permissions.permission_id

// Facilities
ref: users.id < facilities.owner_id
ref: sports.id < facilities.sport_id
ref: facilities.id < facility_images.facility_id
ref: facilities.id < facility_utilities.facility_id
ref: utilities.id < facility_utilities.utility_id

// Fields
ref: facilities.id < fields.facility_id
ref: fields.id < field_pricing.field_id

// Bookings
ref: users.id < bookings.user_id
ref: fields.id < bookings.field_id
ref: bookings.id < transactions.booking_id
ref: bookings.id - reviews.booking_id
ref: bookings.id - refund_requests.booking_id

// Reviews
ref: users.id < reviews.user_id
ref: facilities.id < reviews.facility_id

// Refund
ref: users.id < refund_requests.user_id

// Notifications & Chat
ref: users.id < notifications.user_id
ref: users.id < chat_logs.user_id